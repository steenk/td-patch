/* td-patch v0.1.4, (c) 2015 Steen Klingberg. License: MIT */
!function(r,e){"function"==typeof define&&define.amd?define(e):"undefined"!=typeof module?module.exports=e():r.tdpatch=e()}(this,function(){function r(r){return"op"in r&&"path"in r&&(r.op.match(c)&&"value"in r||r.op.match(u)&&"from"in r||r.op.match("remove"))}function e(r,e){var o,t,n=!1;if("string"==typeof r&&(r=JSON.parse(r)),"object"==typeof r){if("string"==typeof e)o=e.split("/");else{if(!Array.isArray(e))return;o=e}return o.forEach(function(e){n||(e=e.replace("~1","/").replace("~0","~"),""===e?t=r:"undefined"==typeof t[e]?(n=!0,t=void 0):t=t[e])}),t}}function o(r,o,t){return e(r,o)==t}function t(r,o){if(void 0===e(r,o))return!1;var t=o.split("/"),n=t.pop(),i=e(r,t);if(delete i[n],Array.isArray(i)){var p=t.pop();e(r,t)[p]=i.filter(function(r){return void 0!==r})}return!0}function n(r,o,t){var n=e(r,o),i=o.split("/"),p=i.pop(),a=e(r,i);if(void 0===a)return!1;if(Array.isArray(a)){if(!(n>=p))return!1;a.splice(p,0,t)}else{if(void 0!==n)return!1;a[p]=t}return!0}function i(r,o,t){var n=o.split("/"),i=n.pop(),p=e(r,n);return void 0===p?!1:(delete p[i],p[i]=t,!0)}function p(r,o,t){var n=f(e(r,t),0),i=o.split("/"),p=i.pop(),a=e(r,i);if(void 0===a)return!1;a[p]=n;var c=t.split("/"),u=c.pop(),l=e(r,c);return delete l[u],!0}function a(r,o,t){var n=f(e(r,t),0),i=o.split("/"),p=i.pop(),a=e(r,i);return void 0===a?!1:(a[p]=n,!0)}function f(r,e){if(e>256)return void console.error(new Error("Structure is too deep."));if(null===r)return null;if("object"!=typeof r)return r;var o,t,n=Object.prototype.toString.call(r);if("[object Date]"===n)return new Date(r);if(0===n.indexOf("[object HTML"))return r.cloneNode(!0);if(0===n.indexOf("[object SVG"))return r.cloneNode(!0);if("[object Array]"===n)t=[];else{if("[object Object]"!==n)return void 0;t={}}for(o in r)t[o]=f(r[o],e+1);return t}var c=/^test$|^add$|^replace$/,u=/^move$|^copy$/;return function(e,c){if(Array.isArray(c)&&"object"==typeof e){var u=f(e,0),l=!1;return c.forEach(function(e){return l?void 0:r(e)?void("test"===e.op?o(u,e.path,e.value)||(console.error(new Error("Patch tested wrong.")),l=!0):"remove"===e.op?t(u,e.path)||(console.error(new Error("Error in remove operation.")),l=!0):"add"===e.op?n(u,e.path,e.value)||(console.error(new Error("Error in add operation.")),l=!0):"replace"===e.op?i(u,e.path,e.value)||(console.error(new Error("Error in replace operation.")),l=!0):"move"===e.op?p(u,e.path,e.from)||(console.error(new Error("Error in move operation.")),l=!0):"copy"===e.op&&(a(u,e.path,e.from)||(console.error(new Error("Error in copy operation.")),l=!0))):(console.error(new Error("Patch is not valid.")),void(l=!0))}),l?void 0:u}}});