/* td-patch v0.1.7, (c) 2015 Steen Klingberg. License: MIT */
!function(r,e){"function"==typeof define&&define.amd?define(e):"undefined"!=typeof module?module.exports=e():r.tdpatch=e()}(this,function(){function r(r){return"op"in r&&"path"in r&&(r.op.match(u)&&"value"in r||r.op.match(c)&&"from"in r||r.op.match("remove"))}function e(r,e){var o,t,n=!1;if("string"==typeof r&&(r=JSON.parse(r)),"object"==typeof r){if("string"==typeof e)o=e.split("/");else{if(!Array.isArray(e))return;o=e}return o.forEach(function(e){n||(e=e.replace("~1","/").replace("~0","~"),""===e?t=r:"undefined"==typeof t[e]?(n=!0,t=void 0):t=t[e])}),t}}function o(r,o,t){return e(r,o)==t}function t(r,o){if(void 0===e(r,o))return!1;var t=o.split("/"),n=t.pop(),i=e(r,t);if(delete i[n],Array.isArray(i)){var p=t.pop();e(r,t)[p]=i.filter(function(r){return void 0!==r})}return!0}function n(r,o,t){var n=e(r,o),i=o.split("/"),p=i.pop(),f=e(r,i);if(void 0===f)return!1;if(Array.isArray(f)){if(!(p<=f.length))return!1;f.splice(p,0,t)}else{if(void 0!==n)return!1;f[p]=t}return!0}function i(r,o,t){if(void 0===e(r,o))return!1;var n=o.split("/"),i=n.pop(),p=e(r,n);return void 0===p?!1:(delete p[i],p[i]=t,!0)}function p(r,o,t){if(void 0===e(r,o))return!1;var n=a(e(r,t),0),i=o.split("/"),p=i.pop(),f=e(r,i);if(void 0===f)return!1;f[p]=n;var u=t.split("/"),c=u.pop(),d=e(r,u);return delete d[c],!0}function f(r,o,t){if(void 0===e(r,o))return!1;var n=a(e(r,t),0),i=o.split("/"),p=i.pop(),f=e(r,i);return void 0===f?!1:(f[p]=n,!0)}function a(r,e){if(e>256)return void console.error(new Error("Structure is too deep."));if(null===r)return null;if("object"!=typeof r)return r;var o,t,n=Object.prototype.toString.call(r);if("[object Date]"===n)return new Date(r);if(0===n.indexOf("[object HTML"))return r.cloneNode(!0);if(0===n.indexOf("[object SVG"))return r.cloneNode(!0);if("[object Array]"===n)t=[];else{if("[object Object]"!==n)return void 0;t={}}for(o in r)t[o]=a(r[o],e+1);return t}var u=/^test$|^add$|^replace$/,c=/^move$|^copy$/;return function(e,u){if(Array.isArray(u)&&"object"==typeof e){var c=a(e,0),d=!1;return u.forEach(function(e){return d?void 0:r(e)?void("test"===e.op?o(c,e.path,e.value)||(console.error(new Error("Patch tested wrong.")),d=!0):"remove"===e.op?t(c,e.path)||(console.error(new Error("Error in remove operation.")),d=!0):"add"===e.op?n(c,e.path,e.value)||(console.error(new Error("Error in add operation.")),d=!0):"replace"===e.op?i(c,e.path,e.value)||(console.error(new Error("Error in replace operation.")),d=!0):"move"===e.op?p(c,e.path,e.from)||(console.error(new Error("Error in move operation.")),d=!0):"copy"===e.op&&(f(c,e.path,e.from)||(console.error(new Error("Error in copy operation.")),d=!0))):(console.error(new Error("Patch is not valid.")),void(d=!0))}),d?void 0:c}}});